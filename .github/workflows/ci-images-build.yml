name: CI - images build & lint

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: ./scripts

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

      # ---- ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· chrome-versions.json ----
      - name: Read latest Chrome version from chrome-versions.json
        id: versions
        run: |
          set -e

          if [ ! -f chrome-versions.json ]; then
            echo "âŒ ERROR: chrome-versions.json not found."
            exit 1
          fi

          if [ ! -s chrome-versions.json ]; then
            echo "âŒ ERROR: chrome-versions.json is empty."
            exit 1
          fi

          echo "Reading latest Chrome version from chrome-versions.json..."

          VERSION_KEY=$(jq -r 'keys | .[-1]' chrome-versions.json)

          if [ "$VERSION_KEY" = "null" ] || [ -z "$VERSION_KEY" ]; then
            echo "âŒ ERROR: No version keys found."
            exit 1
          fi

          CHROME_DEB_VERSION=$(jq -r --arg v "$VERSION_KEY" '.[$v].chrome_deb_version' chrome-versions.json)
          CHROMEDRIVER_VERSION=$(jq -r --arg v "$VERSION_KEY" '.[$v].chromedriver_version' chrome-versions.json)

          if [ -z "$CHROME_DEB_VERSION" ] || [ "$CHROME_DEB_VERSION" = "null" ]; then
            echo "âŒ ERROR: chrome_deb_version missing."
            exit 1
          fi
          if [ -z "$CHROMEDRIVER_VERSION" ] || [ "$CHROMEDRIVER_VERSION" = "null" ]; then
            echo "âŒ ERROR: chromedriver_version missing."
            exit 1
          fi

          echo "âœ” Using version:"
          echo "  version_key:          $VERSION_KEY"
          echo "  chrome_deb_version:   $CHROME_DEB_VERSION"
          echo "  chromedriver_version: $CHROMEDRIVER_VERSION"

          echo "version_key=$VERSION_KEY" >> "$GITHUB_OUTPUT"
          echo "chrome_deb_version=$CHROME_DEB_VERSION" >> "$GITHUB_OUTPUT"
          echo "chromedriver_version=$CHROMEDRIVER_VERSION" >> "$GITHUB_OUTPUT"

      - name: Make images script executable
        run: chmod +x ./images

      - name: Build Chrome VNC image via ./images
        run: |
          echo "ðŸš€ Building Docker image for Chrome ${{ steps.versions.outputs.version_key }}"
          ./images chrome \
            -b "${{ steps.versions.outputs.chrome_deb_version }}" \
            -d "${{ steps.versions.outputs.chromedriver_version }}" \
            -t lafisteri/vnc_chrome:ci-test \
            vnc_chrome
